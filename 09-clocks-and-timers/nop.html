<!DOCTYPE HTML>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <title></title>
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">

        <base href="../">

        <link rel="stylesheet" href="book.css">
        <link href='https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800' rel='stylesheet' type='text/css'>

        <link rel="shortcut icon" href="favicon.png">

        <!-- Font Awesome -->
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css">

        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">

        <!-- MathJax -->
        <script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

        <!-- Fetch JQuery from CDN but have a local fallback -->
        <script src="https://code.jquery.com/jquery-2.1.4.min.js"></script>
        <script>
            if (typeof jQuery == 'undefined') {
                document.write(unescape("%3Cscript src='jquery.js'%3E%3C/script%3E"));
            }
        </script>
    </head>
    <body class="light">
        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme = localStorage.getItem('theme');
            if (theme == null) { theme = 'light'; }
            $('body').removeClass().addClass(theme);
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var sidebar = localStorage.getItem('sidebar');
            if (sidebar === "hidden") { $("html").addClass("sidebar-hidden") }
            else if (sidebar === "visible") { $("html").addClass("sidebar-visible") }
        </script>

        <div id="sidebar" class="sidebar">
            <ul class="chapter"><li class="affix"><a href="README.html">Introduction</a></li><li><a href="01-background/README.html"><strong>1.</strong> Background</a></li><li><a href="02-requirements/README.html"><strong>2.</strong> Hardware/knowledge requirements</a></li><li><a href="03-setup/README.html"><strong>3.</strong> Setting up a development environment</a></li><li><ul class="section"><li><a href="03-setup/linux.html"><strong>3.1.</strong> Linux</a></li><li><a href="03-setup/windows.html"><strong>3.2.</strong> Windows</a></li><li><a href="03-setup/macos.html"><strong>3.3.</strong> macOS</a></li><li><a href="03-setup/verify.html"><strong>3.4.</strong> Verify the installation</a></li></ul></li><li><a href="05-led-roulette/README.html"><strong>4.</strong> LED roulette</a></li><li><ul class="section"><li><a href="05-led-roulette/build-it.html"><strong>4.1.</strong> Build it</a></li><li><a href="05-led-roulette/flash-it.html"><strong>4.2.</strong> Flash it</a></li><li><a href="05-led-roulette/debug-it.html"><strong>4.3.</strong> Debug it</a></li><li><a href="05-led-roulette/the-led-and-delay-modules.html"><strong>4.4.</strong> The <code>led</code> and <code>delay</code> modules</a></li><li><a href="05-led-roulette/the-challenge.html"><strong>4.5.</strong> The challenge</a></li><li><a href="05-led-roulette/my-solution.html"><strong>4.6.</strong> My solution</a></li></ul></li><li><a href="06-hello-world/README.html"><strong>5.</strong> Hello, world!</a></li><li><ul class="section"><li><a href="06-hello-world/panic.html"><strong>5.1.</strong> <code>panic!</code></a></li></ul></li><li><a href="07-registers/README.html"><strong>6.</strong> Registers</a></li><li><ul class="section"><li><a href="07-registers/rtrm.html"><strong>6.1.</strong> RTRM</a></li><li><a href="07-registers/optimization.html"><strong>6.2.</strong> (mis)Optimization</a></li><li><a href="07-registers/bad-address.html"><strong>6.3.</strong> <code>0xBAAAAAAD</code> address</a></li><li><a href="07-registers/spooky-action-at-a-distance.html"><strong>6.4.</strong> Spooky action at a distance</a></li><li><a href="07-registers/type-safe-manipulation.html"><strong>6.5.</strong> Type safe manipulation</a></li></ul></li><li><a href="08-leds-again/README.html"><strong>7.</strong> LEDs, again</a></li><li><ul class="section"><li><a href="08-leds-again/power.html"><strong>7.1.</strong> Power</a></li><li><a href="08-leds-again/configuration.html"><strong>7.2.</strong> Configuration</a></li></ul></li><li><a href="09-clocks-and-timers/README.html"><strong>8.</strong> Clocks and timers</a></li><li><ul class="section"><li><a href="09-clocks-and-timers/for-loop-delays.html"><strong>8.1.</strong> <code>for</code> loop delays</a></li><li><a href="09-clocks-and-timers/nop.html" class="active"><strong>8.2.</strong> NOP</a></li><li><a href="09-clocks-and-timers/one-shot-timer.html"><strong>8.3.</strong> One-shot timer</a></li><li><a href="09-clocks-and-timers/initialization.html"><strong>8.4.</strong> Initialization</a></li><li><a href="09-clocks-and-timers/busy-waiting.html"><strong>8.5.</strong> Busy waiting</a></li><li><a href="09-clocks-and-timers/putting-it-all-together.html"><strong>8.6.</strong> Putting it all together</a></li></ul></li><li><a href="explore.html">What's left for you to explore</a></li><li class="spacer"></li><li class="affix">Appendix</li><li class="affix"><a href="appendix/1-general-troubleshooting/README.html">General troubleshooting</a></li></ul>
        </div>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar" class="menu-bar">
                    <div class="left-buttons">
                        <i id="sidebar-toggle" class="fa fa-bars"></i>
                        <i id="theme-toggle" class="fa fa-paint-brush"></i>
                    </div>

                    <h1 class="menu-title"></h1>

                    <div class="right-buttons">
                        <i id="print-button" class="fa fa-print" title="Print this book"></i>
                    </div>
                </div>

                <div id="content" class="content">
                    <h1>NOP</h1>
<p>If in the previous section you compiled the program in release mode and actually
looked at the disassembly, you probably noticed that the <code>delay</code> function got
optimized away and never got called from within <code>main</code>.</p>
<p>LLVM decided that the function wasn't doing anything worthwhile and just removed
it.</p>
<p>There is a way to prevent LLVM from optimizing the <code>for</code> loop delay: a volatile
assembly instruction. Any instruction will do but NOP (No OPeration) is a
particular good choice in this case because it actually does nothing.</p>
<p>Your <code>for</code> loop delay would become:</p>
<pre><code class="language-rust">#[inline(never)]
fn delay(ms: u16) {
    for _ in 1_000 {
        unsafe { asm!(&quot;nop&quot; :::: &quot;volatile&quot;) }
    }
}
</code></pre>
<p>And this time it won't be compiled away by LLVM when you compile your program in
release mode:</p>
<pre><code>$ arm-none-eabi-objdump -Cd target/thumbv7em-none-eabihf/release/clocks-and-timers

080001da &lt;clocks_and_timers::delay::hc83787721a209f96&gt;:
 80001da:       f44f 707a       mov.w   r0, #1000       ; 0x3e8
 80001de:       3801            subs    r0, #1
 80001e0:       bf00            nop
 80001e2:       d1fc            bne.n   80001de &lt;clocks_and_timers::delay::hc83787721a209f96+0x4&gt;
 80001e4:       4770            bx      lr
</code></pre>
<p>Now, test this: Compile the program in debug mode and run it then compile the
program in release mode and run it. What's the difference between them? What do
you think is the main cause of the difference? Can you think of a way to make
them equivalent or at least more similar again?</p>

                </div>

                <!-- Mobile navigation buttons -->
                
                    <a href="09-clocks-and-timers/for-loop-delays.html" class="mobile-nav-chapters previous">
                        <i class="fa fa-angle-left"></i>
                    </a>
                

                
                    <a href="09-clocks-and-timers/one-shot-timer.html" class="mobile-nav-chapters next">
                        <i class="fa fa-angle-right"></i>
                    </a>
                

            </div>

            
                <a href="09-clocks-and-timers/for-loop-delays.html" class="nav-chapters previous" title="You can navigate through the chapters using the arrow keys">
                    <i class="fa fa-angle-left"></i>
                </a>
            

            
                <a href="09-clocks-and-timers/one-shot-timer.html" class="nav-chapters next" title="You can navigate through the chapters using the arrow keys">
                    <i class="fa fa-angle-right"></i>
                </a>
            

        </div>


        <!-- Local fallback for Font Awesome -->
        <script>
            if ($(".fa").css("font-family") !== "FontAwesome") {
                $('<link rel="stylesheet" type="text/css" href="_FontAwesome/css/font-awesome.css">').prependTo('head');
            }
        </script>

        <!-- Livereload script (if served using the cli tool) -->
        

        <script src="highlight.js"></script>
        <script src="book.js"></script>
    </body>
</html>
